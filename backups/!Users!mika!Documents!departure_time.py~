import requests
import json
import os

def get_booking_items(start_date, end_date):
    """Get all relevant booking items from elasticsearch"""
    bi_uri = os.environ.get('COMTRAVO_BI_URI', 'http://bi')
    bi_user = os.environ.get('COMTRAVO_BI_USER')
    bi_password = os.environ.get('COMTRAVO_BI_PASSWORD')
    booking_items = []
    try:
        # Get scroll id, filter to include start_date and exclude end_date UTC 00:00:00
        query = {
            "query": {
                "bool": {
                    "should": [
                        {
                            "range": {
                                "booking_item.meta_data.created_at": {
                                    "gte": '{}'.format(start_date.strftime("%Y-%m-%dT00:00:00Z")),
                                    "lt": '{}'.format(end_date.strftime("%Y-%m-%dT00:00:00Z"))
                                }
                            }
                        },
                        {
                            "range": {
                                "booking_item.canceled_at": {
                                    "gte": '{}'.format(start_date.strftime("%Y-%m-%dT00:00:00Z")),
                                    "lt": '{}'.format(end_date.strftime("%Y-%m-%dT00:00:00Z"))
                                }
                            }
                        }
                    ],
                    "minimum_should_match": 1
                }
            }
        }
        r = requests.post(bi_uri + '/booking_items/_search?scroll=1m&size=1000',
                          headers={'Accept': 'application/json',
                                   'Content-Type': 'application/json'},
                          auth=(bi_user, bi_password),
                          data=json.dumps(query),
                          verify=False)  # Self signed cert...
        if r.status_code != 200:
            raise Exception('querying elasticsearch on {} failed: {}'.format(
                bi_uri,
                r.status_code))
        # Get results
        r = r.json()
        scroll_id = r['_scroll_id']
        booking_items += r['hits']['hits']
        while True:
            # Iterate scroll until no more items are left
            r = requests.get(bi_uri + '/_search/scroll',
                             headers={'Accept': 'application/json',
                                      'Content-Type': 'application/json'},
                             data=json.dumps({'scroll': '1m',
                                              'scroll_id': scroll_id}),
                             auth=(bi_user, bi_password),
                             verify=False)  # Self signed cert...
            if r.status_code != 200:
                raise Exception('querying elasticsearch on {} failed: {}'.format(
                    bi_uri,
                    r.status_code))
            r = r.json()
            scroll_id = r['_scroll_id']
            if len(r['hits']['hits']) == 0:
                break
            booking_items += r['hits']['hits']
    except requests.exceptions.ConnectionError as e:
        raise Exception("could not connect to elasticsearch: {}".format(e))
    return booking_items
