import json
from ctlearn.pipelines.nlp import NLPPipeline
from ctlearn.utils.dask_trace import Track

# data = json.loads(bz2.BZ2File(
#       '/Users/mika/comtravo/ct-nlp-data/annotated_corpus_2017-02-06T10:48:31Z.json.bz2',
#       'rb').read().decode())
# data = [{'y_content': list(set([t['type'] for t in d['ann']['events']])),
#          'y_confidence': 1 if [t['type'] for t in d['ann']['events']] == ['Flight'] else -1,
#          'y_is_booking': d['ann']['label'], 'msg': d['msg']} for d in data]
# json.dump(data, open('test_msg.json', 'w'))

data = json.load(open('test_msg.json', 'r'))

N = 100
M = 150

pipe = NLPPipeline()
pipe = pipe.fit({'is_booking': [d['y_is_booking'] for d in data[:N]],
                 'event': range(N),
                 'confidence': [d['y_confidence'] for d in data[:N]],
                 'content': [d['y_content'] for d in data[:N]]},
                [d['msg'] for d in data[:N]],
                plot_dsk='pipe_fit_dsk.png')

pred = pipe.transform([d['msg'] for d in data[N:N+M]])
