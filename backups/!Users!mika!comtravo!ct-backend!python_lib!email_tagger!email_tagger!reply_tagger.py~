import regex as re
from brat_io import bratify_ann
from . helpers import tag_wrapper, TagStatus


@tag_wrapper("replies")
def tag_replies(msg, result):
    """Poor man's tagging of reply lines in an email message:

    Consecutive blocks of lines starting with a '>' character are one
    (part) of a reply

    :param txt: input text to tag
    :return: None of no matches are found or a list of {'match': {'start': pos, 'end': pos}} dicts}
    """
    rx = r'(^>.*(?:\n>.*)*)'
    for m in re.finditer(rx, msg['body'], re.MULTILINE):
        result['annotations'].append(bratify_ann(msg, 'Reply', m.start(0), m.end(0)))
    return TagStatus.success
