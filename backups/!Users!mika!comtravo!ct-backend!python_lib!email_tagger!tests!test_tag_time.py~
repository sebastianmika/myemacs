from email_tagger.tag_persons import tag_persons
from unittest import TestCase
from unittest.mock import patch


@patch('email_tagger.brat.ann2brat.uuid4', return_value='uuid')
@patch('email_tagger.tag_persons.get_companies', return_value=('mocked', 'mocked'))
@patch('email_tagger.tag_persons.get_persons')
class TestTagPersons(TestCase):
    def test_tag_persons_no_persons(self, persons_mock, company_mock, uuid_mock):
        persons_mock.return_value = []
        msg = {'body': "Pls book a flight for Mr. Max Mustermann",
               'from': {'email': 'test@example.com'},
               'to': [], 'cc': []}
        self.assertEqual(tag_persons(msg), [])

    def test_tag_persons_one_person(self, persons_mock, company_mock, uuid_mock):
        persons_mock.return_value = [{'id': 1,
                                      'first_name': 'Max',
                                      'last_name': 'Mustermann',
                                      'full_name': 'Max Mustermann'}]
        msg = {'body': "This is a message Mr. Max Mustermann",
               'from': {'email': 'test@example.com'},
               'to': [], 'cc': []}
        self.assertEqual(tag_persons(msg),
                         [{'id': 'uuid', 'text': 'Mr. Max Mustermann', 'type': 'Person',
                           'attributes': {'crm_ids': [1]}, 'spans': [{'start': 18, 'end': 36}]}])

        msg = {'body': "This is a message Mr. Max Mustermann and here is some more text",
               'from': {'email': 'test@example.com'},
               'to': [], 'cc': []}
        self.assertEqual(tag_persons(msg),
                         [{'id': 'uuid', 'text': 'Mr. Max Mustermann', 'type': 'Person',
                           'attributes': {'crm_ids': [1]},
                           'spans': [{'start': 18, 'end': 36}]}])

        msg = {'body': "This is a message Mr. Max Mustermann and Max Mustermann and Max",
               'from': {'email': 'test@example.com'},
               'to': [], 'cc': []}
        self.assertEqual(tag_persons(msg),
                         [{'attributes': {'crm_ids': [1]},
                           'id': 'uuid',
                           'spans': [{'end': 36, 'start': 18}],
                           'text': 'Mr. Max Mustermann',
                           'type': 'Person'},
                          {'attributes': {'crm_ids': [1]},
                           'id': 'uuid',
                           'spans': [{'end': 55, 'start': 41}],
                           'text': 'Max Mustermann',
                           'type': 'Person'},
                          {'attributes': {'crm_ids': [1]},
                           'id': 'uuid',
                           'spans': [{'end': 63, 'start': 60}],
                           'text': 'Max',
                           'type': 'Person'}])

        msg = {'body': "This is a\nmessage Mr.\nMax Mustermann\nand Max\nMustermann and\nMax",
               'from': {'email': 'test@example.com'},
               'to': [], 'cc': []}
        self.assertEqual(tag_persons(msg),
                         [{'attributes': {'crm_ids': [1]},
                           'id': 'uuid',
                           'spans': [{'end': 21, 'start': 18},
                                     {'end': 36, 'start': 22}],
                           'text': 'Mr. Max Mustermann',
                           'type': 'Person'},
                          {'attributes': {'crm_ids': [1]},
                           'id': 'uuid',
                           'spans': [{'end': 44, 'start': 41},
                                     {'end': 55, 'start': 45}],
                           'text': 'Max Mustermann',
                           'type': 'Person'},
                          {'attributes': {'crm_ids': [1]},
                           'id': 'uuid',
                           'spans': [{'end': 63, 'start': 60}],
                           'text': 'Max',
                           'type': 'Person'}])

        msg = {'body': ("This is a\nmessage Mr.\nMax Mustermann\nand Max\nMustermann and"
                        "\nmax or mustermann lower case does not match"),
               'from': {'email': 'test@example.com'},
               'to': [], 'cc': []}
        self.assertEqual(tag_persons(msg),
                         [{'attributes': {'crm_ids': [1]},
                           'id': 'uuid',
                           'spans': [{'end': 21, 'start': 18}, {'end': 36, 'start': 22}],
                           'text': 'Mr. Max Mustermann',
                           'type': 'Person'},
                          {'attributes': {'crm_ids': [1]},
                           'id': 'uuid',
                           'spans': [{'end': 44, 'start': 41}, {'end': 55, 'start': 45}],
                           'text': 'Max Mustermann',
                           'type': 'Person'}])
