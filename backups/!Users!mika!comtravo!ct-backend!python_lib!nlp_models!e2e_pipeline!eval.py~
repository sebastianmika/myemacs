import requests
import json
from load_corpus import load_raw_data
import pickle
import os

home = os.path.expanduser("~")

raw_data = load_raw_data(os.path.join(home, 'comtravo/data/nlp/nlp_data'), load_from_file=True)

annotate_url = "http://ec2-54-154-214-63.eu-west-1.compute.amazonaws.com:80/v1/annotate"
annotate_url = "http://192.168.99.100:10000/v1/annotate"
headers = {
    'content-type': "application/json",
    'authorization': "JWT eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImJsYUBjb210cmF2by5jb20iLCJhdWQiOiJzMnMuY29tdHJhdm8uY29tIiwiaXNzIjoiczJzLmNvbXRyYXZvLmNvbSJ9.U1keliB6PydV-UsDjezRm9AfShgdKNMXa63tRmm6jkk"
    }


for i, m in enumerate(raw_data):
    if i % 10 == 0:
        print('At message {} of {}'.format(i, len(raw_data)))
    payload = json.dumps(m['msg'])
    response = requests.post(annotate_url, data=payload, headers=headers)
    m['pred_ann'] = response.json()

with open(os.path.join(home, 'comtravo/data/nlp/e2e_eval.pkl'), 'wb') as f:
    pickle.dump(raw_data, f)
