import os
import pickle
import json
from glob import glob
from brat_io import brat2ann


def load_raw_data(path, load_from_file=False):
    """Batch load all data at path. Recurses the directory at path and
    loads each file ending in *.ann. Result listis stored in a file
    raw_data.pkl. To speed up loading this file can directly be loaded
    by specifying load_from_file=True

    """
    print("Loading raw data...")
    if load_from_file:
        with open(os.path.join(path, 'raw_data.pkl'), 'rb') as f:
            raw_data = pickle.load(f)
            ids = pickle.load(f)
    else:
        raw_data = []
        ids = set()
        for file in glob(os.path.join(path, '**/*.ann'), recursive=True):
            file_stem = file.replace(".ann", "")
            ann, _ = brat2ann(file_stem)
            ann['label'] = ann['annotations'][0]['attributes']['request_type']
            ann['source'] = ann['annotations'][0]['attributes']['source']
            ann['language'] = ann['annotations'][0]['attributes']['language']
            ann['annotations'] = ann['annotations'][1:]
            msg = json.load(open(file.replace(".ann", ".json"), 'r'))
            raw_data.append({'id': os.path.basename(file_stem),
                             'msg': msg,
                             'ann': ann})
            ids.add(os.path.basename(file_stem))
        with open(os.path.join(path, 'raw_data.pkl'), 'wb') as f:
            pickle.dump(raw_data, f)
            pickle.dump(ids, f)
    print("...got {} annotations for {} different message".format(len(raw_data), len(ids)))
    return raw_data
