FROM 940226765273.dkr.ecr.eu-west-1.amazonaws.com/ct-spacy:latest

RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app
COPY data /usr/src/app/data
COPY services/nlp /usr/src/app/services/nlp
COPY python_lib/brat_io /usr/src/app/python_lib/brat_io
COPY python_lib/email_tagger /usr/src/app/python_lib/email_tagger
COPY python_lib/jwt_auth /usr/src/app/python_lib/jwt_auth
COPY python_lib/nlp_models /usr/src/app/python_lib/nlp_models
COPY nodejs_lib/passport_google_identity_toolkit /usr/src/app/nodejs_lib/passport_google_identity_toolkit
COPY services/Makefile.default /usr/src/app/services/Makefile.default

RUN pip install -q tox

WORKDIR /usr/src/app/python_lib/jwt_auth
RUN tox --sdistonly
RUN pip install -q .tox/dist/*.zip

WORKDIR /usr/src/app/python_lib/brat_io
RUN tox --sdistonly
RUN pip install -q .tox/dist/*.zip

WORKDIR /usr/src/app/python_lib/nlp_models/msg_type
RUN tox --sdistonly
RUN pip install -q .tox/dist/*.zip

WORKDIR /usr/src/app/python_lib/email_tagger
RUN tox --sdistonly
RUN pip install -q .tox/dist/*.zip

WORKDIR /usr/src/app/services/nlp
RUN tox --sdistonly
RUN pip install -q .tox/dist/*.zip

ENV DEBUG 0
ENV JWT_S2S_AUDIENCE "s2s.comtravo.com"
ENV JWT_S2S_ISSUER "s2s.comtravo.com"
ENV JWT_S2S "some pre shared key"

ENV JWT_GIT_AUDIENCE "720377294595-u0jc7ir6bfd4t0sb27o4204mvgvrm406.apps.googleusercontent.com"
ENV JWT_GIT_ISSUER "https://identitytoolkit.google.com/"

ENV COMTRAVO_DUCKLING_URI "http://duckling/duckling"
ENV COMTRAVO_BI_URI "http://bi"
# ENV COMTRAVO_BI_USER - default None
# ENV COMTRAVO_BI_PASSWORD - default None

EXPOSE 80
CMD ["nlp_api", "80"]

ARG CT_LABEL=""

LABEL com.comtravo.image_specs=$CT_LABEL
