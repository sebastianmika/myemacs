from .es_target import ESTarget


class CorrectionUnknowns(ESTarget):
    def __init__(self):
        super(CorrectionUnknowns, self).__init__('/booking_items/_search')

    def search(self):
        return "Correction Unknowns"

    def query(self, from_, to_, freq):
        term1 = {
            "bool": {"filter": [
                {"exists": {"field": "booking_item.rebooked_from"}},
                {"bool": {
                    "should": [{"term": {"parent_status": "processed"}},
                               {"term": {"parent_status": "fuckup"}}]
                }}
            ]
            }}
        term2 = {
            "bool": {"filter": [
                {"missing": {"field": "booking_item.rebooked_from"}},
                {"bool": {
                    "should": [{"term": {"parent_status": "processed"}},
                               {"term": {"parent_status": "fuckup"}},
                               {"missing": {"field": "parent_status"}}]
                }}
            ]
            }}
        query = {
            "size": 0,
            "query": {
                "bool": {
                    "filter": [
                        {"bool": {
                            "should": [
                                {"bool": {
                                    "must": [
                                        {"term": {"booking_item.status": "fuckup"}},
                                        {"term": {"booking_item.canceled": False}},
                                        {"term": {"booking_item.rebooked": False}},
                                        {"bool": {"should": [term1, term2]}}
                                    ]}},
                                {"bool": {
                                    "must": [
                                        {"exists": {"field": "booking_item.rebooked_from"}},
                                        {"exists": {"field": "booking_item.refund_for"}}
                                    ]}}
                            ]}},
                        {"range": {
                            "booking_item.meta_data.created_at": {
                                "gte": '{}'.format(from_.strftime("%Y-%m-%dT%H:%M:%SZ")),
                                "lt": '{}'.format(to_.strftime("%Y-%m-%dT%H:%M:%SZ"))}}}]
                }
            },
            "aggs": {
                "item_over_time": {
                    "date_histogram": {
                        "field": "booking_item.meta_data.created_at",
                        "interval": "{}".format(freq)
                    }
                }
            }
        }
        es_res = self._query_es(query)
        return [[r['doc_count'], r['key']]
                for r in es_res['aggregations']['item_over_time']['buckets']]
