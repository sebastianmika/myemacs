from . es_target import ESTarget


class OffersCreated(ESTarget):
    def __init__(self):
        super(OffersCreated, self).__init__('/offers/_search')

    def search(self):
        return "Offers Created"

    def uncached_query(self, from_, to_, freq):
        query = {
            "size": 0,
            "query": {
                "bool": {
                    "filter": [
                        {"range": {
                            "meta_data.created_at": {
                                "gte": '{}'.format(from_.strftime("%Y-%m-%dT%H:%M:%SZ")),
                                "lt": '{}'.format(to_.strftime("%Y-%m-%dT%H:%M:%SZ"))}}},
                        {"term": {"status": "processed"}},
                    ]
                }
            },
            "aggs": {
                "item_over_time": {
                    "date_histogram": {
                        "field": "meta_data.created_at",
                        "interval": "{}".format(freq),
                        "min_doc_count": 0,
                        "extended_bounds": {
                            "min": '{}'.format(from_.strftime("%Y-%m-%dT%H:%M:%SZ")),
                            "max": '{}'.format(to_.strftime("%Y-%m-%dT%H:%M:%SZ"))
                        }
                    }
                }
            }
        }
        es_res = self._query_es(query)
        return [[r['doc_count'], r['key']]
                for r in es_res['aggregations']['item_over_time']['buckets']]
