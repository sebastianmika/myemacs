swagger: '2.0'

info:
  version: "1.0.0"
  title: NLP API
  description: Provides an API to parse information from a message

basePath: /v1
schemes:
  - https

paths:
  /annotate:
    post:
      description: get annotations for an email message
      operationId: annotate
      x-swagger-router-controller: nlp.api
      operationId: annotate
      parameters:
        - name: requestBody
          in: body
          description: message to annotate
          schema:
            $ref: '#/definitions/emailMessage'
      tags:
        - NLP
      responses:
        '200':
          description: Ok
          schema:
            $ref: '#/definitions/annotationResponse'
        '401':
          $ref: '#/responses/Unauthorized'

responses:
  Unauthorized:
    description: Unauthorized operation
    schema:
      $ref: '#/definitions/errorModel'

definitions:

  errorModel:
    required:
      - code
      - message
    properties:
      code:
        type: integer
        format: int32
      message:
        type: string

  emailMessage:
    description: e-mail message to annotate
    required:
      - body
      - subject
      - date
      - from
    properties:
      body:
        description: the message body
        type: string
      subject:
        description: the message subject
        type: string
      to:
        description: list of message recipients
        type: array
        items:
          $ref: '#/definitions/emailAddress'
        minLength: 1
      cc:
        description: list of cced message recipients
        type: array
        items:
          $ref: '#/definitions/emailAddress'
        minLength: 0
      from:
        $ref: '#/definitions/emailAddress'
      date:
        description: time of message receipt in miliseconds since the UTC epoch (cf. GMail API)
        type: integer
        minimum: 0

  emailAddress:
    required:
      - email
    properties:
      email:
        type: string
        format: email
        description: the email address
      name:
        type: string
        description: a string with an optional human readable name

  annotationResponse:
    properties:
      language:
        type: string
        minLength: 2
        maxLength: 2
        description: two letter language code, currently only 'de' and 'en'
      messageTypes:
        type: array
        items:
          $ref: '#/definitions/messageTypeAnnotation'
      annotations:
        description: array of annotations
        type: array
        items:
          $ref: '#/definitions/baseAnnotation'
      requests:
        description: array of requests coded in the message
        type: array
        items:
          $ref: '#/definitions/baseRequest'

  messageTypeAnnotation:
    description: type of a message with confidence
    required:
      - messageType
      - confidence
    properties:
      messageType:
        description: type of message
        type: string
        enum: ['booking', 'cancellation', 'rebooking', 'negotiation', 'other']
      confidence:
        $ref: '#/definitions/probability'

  probability:
    description: a probability (i.e. [0 1] floating point value)
    required:
      - value
    properties:
      value:
        type: number
        minimum: 0.0
        maximum: 1.0

  baseAnnotation:
    description: base model for annotations
    required:
      - id
      - tag
      - discriminator
    properties:
      id:
        description: a unique id for this annotation
        type: string
        format: uuid
      tag:
        $ref: '#/definitions/tag'
      discriminator:
        description: discriminator for poor mans polymorphism
        type: string
        enum: ['personAnnotation', 'locationAnnotation', 'flightNumberAnnotation', 'timeRangeAnnotation', 'timePointAnnotation']

  baseRequest:
    description: base model for requests - just a stub for now
    required:
      - discriminator
    properties:
      discriminator:
        description: discriminator for poor mans polymorphism
        type: string
        enum: ['flight', 'returnFlight', 'carRental', 'transfer', 'hotel', 'trainTicket']

  personAnnotation:
    description: a person
    allOf:
      - $ref: '#/definitions/baseAnnotation'
      - type: object
        properties:
          crm_ids:
            description: list of ids of persons in the crm
            type: array
            items:
              description: id of a person in the crm
              type: string

  flightNumberAnnotation:
    description: a flight number
    allOf:
      - $ref: '#/definitions/baseAnnotation'
      - type: object
        properties:
          airline:
            type: string
            minLength: 2
            maxLength: 2
          flightNumber:
            type: string
            minLength: 3

  locationAnnotation:
    description: a location
    allOf:
      - $ref: '#/definitions/baseAnnotation'
      - type: object
        properties:
          locationType:
            description: what kind of location is this?
            type: string
            enum: ['airport', 'city', 'hotel', 'other']
          geonames_id:
            description: the id of this location in geonames (if any)
            type: string
          name:
            description: if locationType==airport, the iata code, else the preferred name
            type: string
          lat:
            description: latitude if known
            type: number
            minimum: -90.0
            maximum: 90.0
          lon:
            description: longitude if known
            type: number
            minimum: -180.0
            maximum: 180.0

  timePointAnnotation:
    description: a time point
    allOf:
      - $ref: '#/definitions/baseAnnotation'
      - type: object
        required:
          - value
          - grain
        properties:
          value:
            type: string
            format: date-time
          grain:
            $ref: '#/definitions/timeGrain'

  timeRangeAnnotation:
    description: a time range
    allOf:
      - $ref: '#/definitions/baseAnnotation'
      - type: object
        properties:
          from:
            type: string
            format: date-time
          to:
            type: string
            format: date-time
          grain:
            $ref: '#/definitions/timeGrain'

  timeGrain:
    properties:
      grain:
        type: string
        enum: ['month', 'week', 'day', 'hour', 'minute']

  tag:
    description: description of a part of text in a message
    required:
      - spans
      - text
      - where
    properties:
      spans:
        description: array of text spans for this tag
        type: array
        items:
          $ref: '#/definitions/span'
      text:
        description: the tagged bit of text, newlines replaced by space, tabs by space
        type: string
      where:
        description: part of the message this tag refers to
        type: string
        enum: ['body', 'subject']

  span:
    required:
      - start
      - end
    properties:
      start:
        description: start of text span
        type: integer
      end:
        description: end of text span
        type: integer
