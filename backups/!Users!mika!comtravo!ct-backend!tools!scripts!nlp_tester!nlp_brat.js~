var uris = {
  alpha: {
    nlp: "https://alpha.comtravo.com:10000/v1/annotate",
    crm: "https://alpha.comtravo.com:5000/v1"
  },
  production: {
    nlp: "https://nlp-api.comtravo.com/v1/annotate",
    crm: "https://crm-api.comtravo.com/v1"
  }
};

function get_crm(what, id) {
  var settings = {
    async: true,
    crossDomain: true,
    url: uris[$("#target input:radio:checked").val()].crm + "/" + what + "/" + id,
    method: "GET",
    headers: {
      "content-type": "application/json",
      "authorization": $("#jwt").val(),
      "cache-control": "no-cache",
    },
    processData: false
  }
  return $.ajax(settings)
};

Handlebars.registerHelper('fmtP', function(value) {
  if (value) {
    return value.toLocaleString("en", {style: "percent"});
  } else {
    return "na";
  }
});

Handlebars.registerHelper('fmt_none', function(value) {
  if (value) {
    return value
  } else {
    return "<em>not found</em>";
  }
});

Handlebars.registerHelper('resolve_user', function(value) {
  var user = get_crm('traveler', value);
  user.done(
    function(user) {
      if (user) {
        $(".user_" + value).text(user.last_name + ", " + user.first_name);
      } else {
        $(".user_" + value).text("unresolved");
      }
    }
  );
  return '<span class="user_' + value + '">Loading...</span>';
});

Handlebars.registerHelper('resolve_company', function(value) {
  var company = get_crm('company', value);
  company.done(
    function(company) {
      if (company) {
        $(".company_" + value).text(company.name);
      } else {
                $(".company_" + value).text("unresolved");
      }
    }
  );
  return '<span class="company_' + value + '">Loading...</span>';
});

Handlebars.registerHelper('fmt_dpt_arv', function(value) {
  if (value) {
    var dpt = "";
    var arv = "";
    if (this.hasOwnProperty('departure_from')) {
      if (this.departure_from.date_value == this.departure_to.date_value) {
        dpt = "departure on " + this.departure_from.date_value + " " +
          this.departure_from.time_value + "-" + this.departure_to.time_value;
      } else {
        dpt = "departure on " + this.departure_from.date_value + " " +
          this.departure_from.time_value + "-" + this.departure_to.date_value + " " + this.departure_to.time_value;
      }
    }
    if (this.hasOwnProperty('arrival_from')) {
      if (this.arrival_from.date_value == this.arrival_to.date_value) {
        arv = "arrival on " + this.arrival_from.date_value + " " +
          this.arrival_from.time_value + "-" + this.arrival_to.time_value;
      } else {
        arv = "arrival on " + this.arrival_from.date_value + " " +
          this.arrival_from.time_value + "-" + this.arrival_to.date_value + " " + this.arrival_to.time_value;
      }
    }
    if (!(dpt || arv)) {
      return "no departure time found";
    }
    else {
      return dpt + " " + arv;
    }
  } else {
    return "na";
  }
});

function create_query() {
  var settings = {
    async: true,
    crossDomain: true,
    url: uris[$("#target input:radio:checked").val()].nlp,
    method: "POST",
    headers: {
      "content-type": "application/json",
      "authorization": $("#jwt").val(),
      "cache-control": "no-cache",
    },
    processData: false,
    dataType: "json",
    data: JSON.stringify({
      "subject": $("#subject").val(),
      "cc": [],
      "from": {
        "name": "",
        "email": $("#from").val()
      },
      "to": [
        {
          "name": "Comtravo",
          "email": "buchung@comtravo.com"
        }
      ],
      "date": Date.now(),
      "zendesk_ticket_id": 0,
      "body": $("#request").val()
    })
  };
  return settings;
};

$( "#submit" ).click(function() {
  $("#submit").button('loading')
  $.ajax(create_query())
    .done(
      function(data) {
        console.log(data);
        var res_template = $("#result_hb").html()
        var result = Handlebars.compile(res_template)(data);
        $("#result").html(result)
        // docData.text = $("#request").val()
        $("#submit").button('reset')
      })
    .fail(
      function(data) {
        alert("Error: " + data.responseJSON.detail);
        $("#submit").button('reset')
      });
});
