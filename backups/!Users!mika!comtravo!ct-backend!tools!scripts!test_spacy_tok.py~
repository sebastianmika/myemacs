from spacy.language import BaseDefaults
from spacy.vocab import Vocab
import spacy.util as util


def get_spacy_path(name):
    target_name, target_version = util.split_data_name(name)
    data_path = util.get_data_path()
    path = util.match_best_version(target_name, target_version, data_path)
    cls = util.get_lang_class(target_name)
    return cls, path


def spacy_tok(lang):
    cls, path = get_spacy_path(lang)

    class SpacyTok():
        def __init__(self, path):         
            self.path = path
            lex_attr_getters = {'LANG': lambda text: lang}
            self.vocab = Vocab(lex_attr_getters=lex_attr_getters)
            # BaseDefaults.create_vocab(self)
            self.tokenizer = BaseDefaults.create_tokenizer(self)

    tok = SpacyTok(path)
    return tok.tokenizer

    # from spacy.language_data import TOKEN_MATCH

    # lex_attr_getters = dict(Language.Defaults.lex_attr_getters)
    # lex_attr_getters[LANG] = lambda text: 'en'
    # from spacy.lemmatizer import Lemmatizer
    # from spacy.vocab import Vocab


def test_spacy_de_tok():
    txt = """Die Flugzeuge der USA und ihre Verbündeten haben keine Uranmunition
    eingesetzt und werden während der Operation Inherent Resolve keine
    Uranmunition im Irak und in Syrien einsetzen." Das sicherte das
    Zentralkommando der Vereinigten Staaten (Centcom) im März 2015
    zu. Diese Munition sei entwickelt worden, um Panzer auf dem
    konventionellen Schlachtfeld zu zerstören. "Der IS besitzt aber nicht
    viele Panzer", begründete das US-Militär seine Entscheidung.

    Nun, knapp zwei Jahre später, hat das Pentagon eingeräumt, doch
    zweimal Uranmunition in Syrien eingesetzt zu haben. Bei zwei
    Luftangriffen gegen Öl-Lastwagen der Terrormiliz "Islamischer Staat"
    (IS) in Syrien beschossen US-Kampfjets ihre Ziele mit panzerbrechender
    Munition, deren Projektile abgereichertes Uran enthielten. Bei den
    Luftschlägen am 16. und 22. November 2015 seien etwa 350 Fahrzeuge
    zerstört worden. Die Angriffe ereigneten sich im Osten Syriens, in der
    Nähe der syrisch-irakischen Grenzstadt Abu Kamal beziehungsweise in
    der Nähe der Großstadt Deir al-Sor.

    Nach Angaben von Centcom-Sprecher Josh Jacques feuerten die Jets
    vom Typ A-10, Spitzname "Warzenschwein", aus ihren
    Maschinenkanonen insgesamt 5265 30-Millimeter-Patronen auf die
    IS-Fahrzeuge ab. Das entspricht einer Menge von rund 1,5 Tonnen
    Munition.

    Uranmunition hat enorme Durchschlagskraft

    Es ist der erste bestätigte Einsatz von Uranmunition durch das
    US-Militär seit der Irak-Invasion 2003. Damals verschossen
    Amerikaner und Briten Hunderte Tonnen dieser radioaktiven
    Munition. Die gesundheitlichen Spätfolgen sind bis heute nicht
    abschließend erforscht. Mediziner befürchten aber, dass die
    Uranpartikel eingeatmet werden können, sich in der Lunge auflösen
    und so in die Blutbahn und ins Gewebe gelangen. Auch über Wunden
    könne die Substanz in den Körper eindringen und Vergiftungen oder
    Krebs auslösen."""
    import spacy

    full_de = spacy.load('de')
    tok_de = spacy_de_tok()
    for full_sp, red_sp in zip(full_de(txt), tok_de(txt)):
        assert full_sp.orth_ == red_sp.orth_
        assert full_sp.shape_ == red_sp.shape_
        assert full_sp.orth_ == red_sp.orth_
        assert full_sp.idx == red_sp.idx
        assert len(full_sp) == len(red_sp)
        assert full_sp.whitespace_ == red_sp.whitespace_
