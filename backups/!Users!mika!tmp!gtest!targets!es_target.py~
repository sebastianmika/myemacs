import os
import requests
import json
from base_target import BaseTarget


class ESTarget(BaseTarget):
    def __init__(self, endpoint):
        self.bi_uri = os.environ.get('COMTRAVO_BI_URI', 'http://bi')
        self.endpoint = endpoint
        self.bi_user = os.environ.get('COMTRAVO_BI_USER')
        self.bi_password = os.environ.get('COMTRAVO_BI_PASSWORD')

    def _query_es(self, query):
        r = requests.post(self.bi_uri + self.endpoint,
                          headers={'Accept': 'application/json',
                                   'Content-Type': 'application/json',
                                   'Accept-Encoding': 'gzip, deflate'},
                          auth=(self.bi_user, self.bi_password),
                          data=json.dumps(query),
                          verify=False)  # Self signed cert...
        if r.status_code != 200:
            raise Exception('querying elasticsearch on {} failed: {}\n{}'.format(
                self.bi_uri,
                r.status_code,
                query))
        # Get results
        return r.json()
